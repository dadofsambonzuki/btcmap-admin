{% extends "base.html" %}

{% block title %}Select Area{% endblock %}

{% block content %}
<div class="starter-template">
    <h1>Select an Area</h1>
    <div class="row justify-content-center">
        <div class="col-md-4">
            <form id="search-form" class="form-inline mb-3">
                <input type="text" id="search-input" name="search" class="form-control mb-2 mr-sm-2" placeholder="Search by name ...">
            </form>
            <div id="search-results"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');

    async function performSearch() {
        const searchQuery = searchInput.value.trim().toLowerCase();
        
        // Don't perform empty searches
        if (searchQuery === '') {
            searchResults.innerHTML = '<p>Enter a search query to see results.</p>';
            return;
        }

        try {
            // Verify search query
            if (typeof searchQuery !== 'string') {
                throw new Error('Invalid search query type');
            }

            const response = await fetch('/api/search_areas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: searchQuery })
            });

            // Handle non-OK responses
            if (!response.ok) {
                const errorData = await response.text();
                const error = new Error(`HTTP error! status: ${response.status}, message: ${errorData}`);
                error.status = response.status;
                error.responseText = errorData;
                throw error;
            }

            const data = await response.json();
            
            // Validate response data
            if (!data) {
                const error = new Error('Invalid response data');
                error.name = 'DataValidationError';
                throw error;
            }

            if (data.error) {
                const error = new Error(data.error.message || 'Unknown server error');
                error.name = 'ServerError';
                error.details = data.error;
                throw error;
            }

            // Ensure data is an array
            const areas = Array.isArray(data) ? data : [];

            if (areas.length === 0) {
                searchResults.innerHTML = '<p>No results found.</p>';
            } else {
                searchResults.innerHTML = areas.map(area => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h5 class="card-title">${area.name || 'Unnamed Area'}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${area.type || 'Unknown Type'}</h6>
                            <p class="card-text">ID: ${area.id}</p>
                            <a href="/show_area/${area.id}" class="btn btn-primary btn-sm">View</a>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            // Ensure error object has all required properties
            const errorDetails = {
                name: error.name || 'Error',
                message: error.message || 'An unknown error occurred',
                stack: error.stack || new Error().stack,
                status: error.status,
                responseText: error.responseText,
                details: error.details
            };

            console.error('Error performing search:', errorDetails);

            let errorMessage = 'An unexpected error occurred. Please try again later.';

            // Provide specific error messages based on error type
            if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                errorMessage = 'Network error. Please check your internet connection and try again.';
            } else if (error.name === 'ServerError') {
                errorMessage = `Server error: ${error.message}`;
            } else if (error.name === 'DataValidationError') {
                errorMessage = 'The server returned an invalid response. Please try again.';
            } else if (error.status) {
                errorMessage = `Server returned error ${error.status}: ${error.responseText || 'Unknown error'}`;
            } else if (error.message.includes('timeout') || error.message.includes('Timeout')) {
                errorMessage = 'The request timed out. Please try again.';
            }

            showToast('Error', errorMessage, 'error');
            searchResults.innerHTML = `<p class="text-danger">${errorMessage}</p>`;
        }
    }

    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300); // Debounce search
    });

    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch();
    });

    // Initial message
    searchResults.innerHTML = '<p>Enter a search query to see results.</p>';

    // Handle unhandled rejections
    window.addEventListener('unhandledrejection', function(event) {
        const error = event.reason;
        const errorDetails = {
            name: error.name || 'UnhandledRejection',
            message: error.message || 'An unhandled promise rejection occurred',
            stack: error.stack || new Error().stack
        };
        
        console.error('Unhandled rejection:', errorDetails);
        showToast('Error', 'An unexpected error occurred. Please try again later.', 'error');
    });
});
</script>
{% endblock %}
