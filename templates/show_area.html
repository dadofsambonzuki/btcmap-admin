{% extends "base.html" %}

{% block title %}{{ area.tags.get('name', 'Unknown Area') }}{% endblock %}

{% block content %}
<div class="starter-template">
    <h1>Area Details: {{ area.tags.get('name', 'Unknown') }}</h1>
    <p class="lead">Type: {{ area.tags.get('type', 'Unknown') }}</p>

    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">Metadata</h3>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Area ID:</dt>
                <dd class="col-sm-9">{{ area.id }}</dd>

                <dt class="col-sm-3">Created At:</dt>
                <dd class="col-sm-9">{{ area.created_at|default('N/A') }}</dd>

                <dt class="col-sm-3">Updated At:</dt>
                <dd class="col-sm-9">{{ area.updated_at|default('N/A') }}</dd>
            </dl>
        </div>
    </div>

    {% if geo_json %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">Area Map</h3>
        </div>
        <div class="card-body p-0">
            <div id="map" class="map-container"></div>
        </div>
    </div>
    {% endif %}

    <h3>Tags</h3>
    <table class="table table-striped" id="tags-table">
        <thead>
            <tr>
                <th style="width: 30%;">Key</th>
                <th style="width: 40%;">Value</th>
                <th style="width: 30%;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for key, value in area.tags.items() %}
            {% if key != 'geo_json' %}
            <tr data-key="{{ key }}">
                <td>{{ key }}</td>
                <td class="tag-value-cell">
                    <div class="tag-value-content">{{ value }}</div>
                    <input type="text" class="form-control tag-input" style="display: none;">
                    <select class="form-control tag-select" style="display: none;"></select>
                    <div class="invalid-feedback"></div>
                </td>
                <td>
                    <button class="btn btn-primary btn-sm edit-tag">Edit</button>
                    <button class="btn btn-success btn-sm update-tag" style="display: none;">Update</button>
                    <button class="btn btn-secondary btn-sm cancel-edit" style="display: none;">Cancel</button>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <div class="mt-5 p-3 bg-danger text-white">
        <h3>Danger Zone</h3>
        <p>Be careful! Actions in this section can't be undone.</p>
        <button id="remove-area-btn" class="btn btn-outline-light">Remove Area</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script>
let map = null;
let geoJsonLayer = null;

function cleanupMap() {
    try {
        if (geoJsonLayer && map) {
            map.removeLayer(geoJsonLayer);
            geoJsonLayer = null;
        }
        if (map) {
            map.remove();
            map = null;
        }
    } catch (error) {
        console.error('Error cleaning up map:', error);
    }
}

function initializeMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
        console.error('Map container not found');
        return false;
    }

    try {
        if (map) {
            cleanupMap();
        }

        map = L.map('map', {
            attributionControl: true,
            zoomControl: true,
            minZoom: 2,
            maxZoom: 18
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        {% if geo_json %}
        try {
            const geoJson = {{ geo_json | tojson | safe }};
            if (!geoJson) {
                throw new Error('No GeoJSON data available');
            }

            geoJsonLayer = L.geoJSON(geoJson, {
                style: {
                    color: '#3388ff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.2
                }
            }).addTo(map);

            const bounds = geoJsonLayer.getBounds();
            if (bounds.isValid()) {
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 16
                });
            } else {
                console.warn('Invalid bounds for GeoJSON layer');
                map.setView([0, 0], 2);
            }
        } catch (error) {
            console.error('Error adding GeoJSON to map:', error);
            showToast('Error', `Failed to display area boundaries: ${error.message}`, 'error');
            map.setView([0, 0], 2);
        }
        {% endif %}

        return true;
    } catch (error) {
        console.error('Error initializing map:', error);
        showToast('Error', `Failed to initialize map: ${error.message}`, 'error');
        cleanupMap();
        return false;
    }
}

function validateAndConvertValue(value, type) {
    if (!value || value.toString().trim() === '') {
        throw new Error('Value cannot be empty');
    }

    const stringValue = value.toString().trim();

    switch (type) {
        case 'integer':
            if (!/^\d+$/.test(stringValue)) {
                throw new Error('Must be a whole number');
            }
            const intValue = parseInt(stringValue, 10);
            if (intValue < 0) {
                throw new Error('Must be non-negative');
            }
            return intValue;

        case 'number':
            if (!/^\d*\.?\d+$/.test(stringValue)) {
                throw new Error('Must be a valid number');
            }
            const floatValue = parseFloat(stringValue);
            if (floatValue < 0) {
                throw new Error('Must be non-negative');
            }
            return Math.round(floatValue * 100) / 100;

        default:
            return stringValue;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const tagsTable = document.getElementById('tags-table');
    const areaType = "{{ area.tags.get('type', '') }}";
    const areaTypeRequirements = {{ area_type_requirements | tojson | safe }};

    {% if geo_json %}
    // Initialize map after DOM is loaded
    window.addEventListener('load', function() {
        initializeMap();
    });

    // Handle window resize with debounce
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            if (map) {
                map.invalidateSize();
            }
        }, 250);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', cleanupMap);
    {% endif %}

    function startEditing(row) {
        const valueCell = row.querySelector('.tag-value-cell');
        const content = valueCell.querySelector('.tag-value-content');
        const input = valueCell.querySelector('.tag-input');
        const select = valueCell.querySelector('.tag-select');
        const key = row.dataset.key;

        // Reset validation state
        input.classList.remove('is-invalid');
        select.classList.remove('is-invalid');
        valueCell.querySelector('.invalid-feedback').style.display = 'none';

        const currentValue = content.textContent.trim();
        const fieldRequirements = areaTypeRequirements[areaType]?.[key] || { type: 'text' };

        content.style.display = 'none';
        row.querySelector('.edit-tag').style.display = 'none';
        row.querySelector('.update-tag').style.display = 'inline-block';
        row.querySelector('.cancel-edit').style.display = 'inline-block';

        if (fieldRequirements.allowed_values) {
            select.innerHTML = `
                <option value="">Select ${key}</option>
                ${fieldRequirements.allowed_values
                    .map(value => `<option value="${value}"${currentValue === value ? ' selected' : ''}>${value}</option>`)
                    .join('')}
            `;
            select.style.display = 'block';
            input.style.display = 'none';
        } else {
            input.value = currentValue;
            input.type = fieldRequirements.type === 'integer' || fieldRequirements.type === 'number' ? 'number' : 'text';
            if (input.type === 'number') {
                input.min = '0';
                input.step = fieldRequirements.type === 'integer' ? '1' : '0.01';
            }
            input.style.display = 'block';
            select.style.display = 'none';
        }
    }

    function updateTag(row) {
        const key = row.dataset.key;
        const valueCell = row.querySelector('.tag-value-cell');
        const content = valueCell.querySelector('.tag-value-content');
        const input = valueCell.querySelector('.tag-input');
        const select = valueCell.querySelector('.tag-select');
        const feedback = valueCell.querySelector('.invalid-feedback');

        // Reset validation state
        input.classList.remove('is-invalid');
        select.classList.remove('is-invalid');
        feedback.style.display = 'none';

        try {
            const rawValue = select.style.display === 'block' ? select.value : input.value;
            const fieldRequirements = areaTypeRequirements[areaType]?.[key] || { type: 'text' };
            const processedValue = validateAndConvertValue(rawValue, fieldRequirements.type);

            fetch('/api/set_area_tag', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: '{{ area.id }}',
                    name: key,
                    value: processedValue
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error?.message || `Server error: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error.message || 'Server error');
                }
                content.textContent = String(processedValue);
                showToast('Success', 'Tag updated successfully', 'success');
                cancelEditing(row);
            })
            .catch(error => {
                const errorMessage = error.message || 'Failed to update tag';
                showToast('Error', errorMessage, 'error');
                
                const activeInput = select.style.display === 'block' ? select : input;
                activeInput.classList.add('is-invalid');
                feedback.textContent = errorMessage;
                feedback.style.display = 'block';
            });
        } catch (error) {
            const errorMessage = error.message || 'Invalid value';
            showToast('Error', errorMessage, 'error');
            
            const activeInput = select.style.display === 'block' ? select : input;
            activeInput.classList.add('is-invalid');
            feedback.textContent = errorMessage;
            feedback.style.display = 'block';
        }
    }

    function cancelEditing(row) {
        const valueCell = row.querySelector('.tag-value-cell');
        
        valueCell.querySelector('.tag-value-content').style.display = 'block';
        valueCell.querySelector('.tag-input').style.display = 'none';
        valueCell.querySelector('.tag-select').style.display = 'none';
        row.querySelector('.edit-tag').style.display = 'inline-block';
        row.querySelector('.update-tag').style.display = 'none';
        row.querySelector('.cancel-edit').style.display = 'none';

        // Reset validation states
        valueCell.querySelector('.tag-input').classList.remove('is-invalid');
        valueCell.querySelector('.tag-select').classList.remove('is-invalid');
        valueCell.querySelector('.invalid-feedback').style.display = 'none';
    }

    // Event delegation for tag actions
    tagsTable.addEventListener('click', function(e) {
        const target = e.target;
        const row = target.closest('tr');
        
        if (!row) return;

        if (target.classList.contains('edit-tag')) {
            startEditing(row);
        } else if (target.classList.contains('update-tag')) {
            updateTag(row);
        } else if (target.classList.contains('cancel-edit')) {
            cancelEditing(row);
        }
    });

    // Remove area button handling
    const removeAreaBtn = document.getElementById('remove-area-btn');
    if (removeAreaBtn) {
        removeAreaBtn.addEventListener('click', function() {
            showToast('Confirm', 'Are you sure you want to remove this area?', 'warning', {
                confirmButtonText: 'Yes, remove it',
                cancelButtonText: 'Cancel',
                onConfirm: () => {
                    fetch('/api/remove_area', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: '{{ area.id }}' })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error?.message || `Server error: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.error.message || 'Failed to remove area');
                        }
                        window.location.href = '/select_area';
                    })
                    .catch(error => {
                        console.error('Error removing area:', error);
                        showToast('Error', error.message || 'Failed to remove area', 'error');
                    });
                }
            });
        });
    }
});
</script>
{% endblock %}
