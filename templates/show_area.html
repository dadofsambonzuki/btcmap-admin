{% extends "base.html" %}

{% block title %}{{ area.tags.get('name', 'Unknown Area') }}{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mt-5">{{ area.tags.get('name', 'Unknown Area') }}</h1>
    <h3 class="text-muted">Type: {{ area.tags.get('type', 'Unknown Type') }}</h3>
    
    <!-- Map container with Edit GeoJSON button -->
    <div id="map" class="position-relative mb-3" style="height: 400px;">
        <button id="edit-geojson-btn" class="btn btn-primary btn-sm position-absolute" style="top: 10px; right: 10px; z-index: 1000;">Edit GeoJSON</button>
    </div>
    
    <!-- GeoJSON editing section -->
    <div id="geojson-editor" class="mb-3">
        <textarea id="geojson-input" class="form-control mb-2" rows="5" style="display: none;"></textarea>
        <div class="button-group" style="display: none;">
            <button id="show-btn" class="btn btn-primary">Show</button>
            <button id="update-btn" class="btn btn-success">Update</button>
            <button id="cancel-geojson-btn" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <!-- Area details table -->
    <div class="card mt-3">
        <div class="card-body">
            <table class="table" id="tags-table">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in area.tags.items() %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm edit-tag" data-key="{{ key }}" data-value="{{ value }}">Edit</button>
                            {% if not (area_type_requirements.get(key, {}).get('required', False)) %}
                            <button type="button" class="btn btn-danger btn-sm remove-tag" data-key="{{ key }}">Remove</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="mt-3 text-center">
                <button type="button" id="add-optional-tag-btn" class="btn btn-secondary">Add Optional Field</button>
                <button type="button" id="add-custom-tag-btn" class="btn btn-secondary">Add Custom Field</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script>
let map = null;
let geoJsonLayer = null;
let mapInitialized = false;
let currentGeoJson = null;
let previouslySavedGeoJson = null;

function cleanupMap() {
    if (map) {
        try {
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
                geoJsonLayer = null;
            }
            map.remove();
            map = null;
            mapInitialized = false;
            console.log('Map cleanup successful');
        } catch (error) {
            console.error('Error cleaning up map:', error);
        }
    }
}

function initializeMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
        console.error('Map container element not found');
        return;
    }

    if (mapInitialized) {
        console.log('Map already initialized');
        return;
    }

    try {
        cleanupMap();
        
        map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        console.log('Base map initialized successfully');

        {% if geo_json %}
        try {
            const geoJsonData = {{ geo_json | tojson | safe }};
            console.log('Initial GeoJSON data:', geoJsonData);

            if (!geoJsonData || typeof geoJsonData !== 'object') {
                throw new Error('Invalid GeoJSON: not an object');
            }

            if (!geoJsonData.type || !geoJsonData.coordinates) {
                throw new Error('Invalid GeoJSON structure: missing type or coordinates');
            }

            if (!['Polygon', 'MultiPolygon'].includes(geoJsonData.type)) {
                throw new Error('Invalid GeoJSON type: must be Polygon or MultiPolygon');
            }

            currentGeoJson = geoJsonData;
            previouslySavedGeoJson = geoJsonData;
            
            geoJsonLayer = L.geoJSON(geoJsonData).addTo(map);
            if (geoJsonLayer && geoJsonLayer.getBounds().isValid()) {
                map.fitBounds(geoJsonLayer.getBounds());
                console.log('GeoJSON layer added and map bounds set');
            } else {
                console.warn('GeoJSON layer added but bounds are invalid');
            }
        } catch (error) {
            console.error('Error adding GeoJSON to map:', error);
            showToast('Error', 'Failed to display GeoJSON data: ' + (error.message || 'Unknown error'), 'error');
        }
        {% endif %}

        mapInitialized = true;
        console.log('Map initialization complete');
    } catch (error) {
        console.error('Error initializing map:', error);
        showToast('Error', 'Failed to initialize map: ' + (error.message || 'Unknown error'), 'error');
    }
}

function updateOptionalFieldSelect() {
    console.log('Updating optional field select');
    const addOptionalTagBtn = document.getElementById('add-optional-tag-btn');
    
    if (!addOptionalTagBtn) {
        console.warn('Add optional tag button not found');
        return;
    }

    const areaTypeRequirements = {{ area_type_requirements | tojson | safe }};
    const areaType = "{{ area.tags.get('type', '') }}";
    
    try {
        if (!areaType) {
            throw new Error('Area type is not defined');
        }

        if (!areaTypeRequirements || !areaTypeRequirements[areaType]) {
            throw new Error(`Requirements not found for area type: ${areaType}`);
        }

        const existingKeys = getExistingKeys();
        console.log('Existing keys:', existingKeys);

        const optionalFields = Object.entries(areaTypeRequirements[areaType])
            .filter(([key, req]) => !req.required && !existingKeys.includes(key))
            .map(([key]) => key);

        console.log('Available optional fields:', optionalFields);

        document.querySelectorAll('.optional-field-select').forEach(select => {
            const currentValue = select.value;
            select.innerHTML = `
                <option value="">Select Optional Field</option>
                ${optionalFields.map(field => 
                    `<option value="${field}" ${currentValue === field ? 'selected' : ''}>${field}</option>`
                ).join('')}
            `;
        });

        addOptionalTagBtn.disabled = optionalFields.length === 0;
        
        if (optionalFields.length === 0) {
            console.log('No more optional fields available');
        }
    } catch (error) {
        console.error('Error updating optional field select:', error);
        showToast('Error', 'Failed to update optional fields: ' + (error.message || 'Unknown error'), 'error');
        if (addOptionalTagBtn) {
            addOptionalTagBtn.disabled = true;
        }
    }
}

// Rest of the JavaScript code remains the same...
</script>
{% endblock %}
