{% extends "base.html" %}

{% block title %}{{ area.tags.get('name', 'Unknown Area') }}{% endblock %}

{% block content %}
<!-- Previous content remains the same -->
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tagsTable = document.getElementById('tags-table');
        const addOptionalTagButton = document.getElementById('add-optional-tag-btn');
        const addCustomTagButton = document.getElementById('add-custom-tag-btn');
        const areaTypeRequirements = {{ area_type_requirements | tojson | safe }};

        // Map initialization code remains the same...

        function validateNumericValue(value, type) {
            if (!value || value.trim() === '') {
                return { isValid: false, message: 'Value cannot be empty' };
            }

            let num;
            if (type === 'integer') {
                num = parseInt(value);
                if (isNaN(num) || !Number.isInteger(parseFloat(value))) {
                    return { isValid: false, message: 'Value must be a valid integer' };
                }
            } else {
                num = parseFloat(value);
                if (isNaN(num)) {
                    return { isValid: false, message: 'Value must be a valid number' };
                }
            }

            if (num < 0) {
                return { isValid: false, message: 'Value must be non-negative' };
            }

            return { isValid: true, value: num };
        }

        function updateTag(row) {
            const key = row.dataset.key;
            const valueCell = row.querySelector('.tag-value-cell');
            const content = valueCell.querySelector('.tag-value-content');
            const input = valueCell.querySelector('.tag-input');
            const select = valueCell.querySelector('.tag-select');
            const newValue = select.style.display === 'block' ? select.value : input.value;

            // Handle numeric fields
            let processedValue = newValue;
            if (key === 'population') {
                const validation = validateNumericValue(newValue, 'integer');
                if (!validation.isValid) {
                    showToast('Error', `Population: ${validation.message}`, 'error');
                    return;
                }
                processedValue = validation.value;
            } else if (key === 'area_km2') {
                const validation = validateNumericValue(newValue, 'number');
                if (!validation.isValid) {
                    showToast('Error', `Area: ${validation.message}`, 'error');
                    return;
                }
                processedValue = validation.value;
            }

            fetch('/api/set_area_tag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: '{{ area.id }}',
                    name: key,
                    value: processedValue
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('Error', data.error, 'error');
                } else {
                    showToast('Success', 'Tag updated successfully', 'success');
                    content.textContent = newValue;
                    cancelEditing(row);
                }
            })
            .catch(error => {
                showToast('Error', 'An unexpected error occurred', 'error');
                console.error(error);
            });
        }

        // Rest of the code remains the same...
    });
</script>
{% endblock %}
